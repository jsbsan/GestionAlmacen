' Gambas class file

Public Sub Form_Resize()

  TextAreaInforme.x = 0 + 5
  textareainforme.y = 30
  textareainforme.width = Me.Width - 10
  textareainforme.height = Me.Height - 35

End

Public Sub Form_Open()

  Dim tipo As String

  If Me.caption = "Proveedores" Then
    generaProveedores
  Endif

  tipo = "Conceptos"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaConceptos
  End If

  tipo = "Albaranes"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaAlbaranes
  End If

  tipo = "Salidas"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaSalidas
  End If

  tipo = "Facturas"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaFacturas
  End If

  'informes provenientes de tab INFORMES
  tipo = "Descomposicion Albaranes"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaraAlbaranesDescompuesto
  Endif

  tipo = "Resumen Prov/Alb/Fact"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaraResumenProvAlbFact
  Endif

  tipo = "Descompuesto de facturas"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaraDescompuestoFactura
  Endif

  tipo = "Resumen Mes "
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaMesResumenAlbaranes_Facturas
  Endif

  tipo = "Mes Descomposicion Albaranes "
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaMesAlbaranes_Facturas
  Endif

  tipo = "Alquileres por Meses"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaMesalquileres
  Endif

  tipo = "Descomposicion Albaranes Por Dia"
  If Mid(Me.caption, 1, Len(tipo)) = tipo Then
    generaDescompuestosAlbDia
  Endif

End

'--------------------------------------------------Generacion Listado -----------------------------
'-----------------------------------------------------Proveedores------------------------------------
'--------------------------------------------------------------------------------------------------

Public Sub generaProveedores()

  Dim columnas As Integer
  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim c As Integer
  Dim numeracion As New Integer[]
  Dim datos As String 'cadena que contiene los datos a presentar
  Dim esquema As String
  Dim datosproveedor As String
  Dim tipos As String
  'ordenar proveedores alfabeticamente.....
  numeracion = OrdenacionLista.listaOrd(var.Prov_nombre, var.Prov_numero)
  TextAreaInforme.text = "Proveedores" & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Nif:        Proveedor                       Fecha       FormaPago              P.c.                 Telf.      Fax Movil. Correo Direccion C.P. Ciudad Provincia Observaciones"

  textareainforme.text &= Escribe.subraya(esquema) & "\r"

  datosproveedor = ""
  For c = 0 To var.Prov_numero - 1
    a = numeracion[c]

    If var.Prov_id[a] <> "IdB" Then

      datos = var.Prov_Nif[a]
      datos &= "|" & var.Prov_nombre[a]
      datos &= "|" & Format$(var.Prov_Fecha[a], "dd/mm/yy")
      datos &= "|" & var.Prov_fp[a]
      datos &= "|" & var.Prov_pc[a]
      datos &= "|" & var.Prov_Telf[a]
      datos &= "|" & var.Prov_Fax[a]
      datos &= "|" & var.Prov_Movil[a]
      datos &= "|" & var.Prov_Correo[a]
      datos &= "|" & var.Prov_Direccion[a]
      datos &= "|" & var.Prov_cp[a]
      datos &= "|" & var.Prov_Ciudad[a]
      datos &= "|" & var.Prov_Provincia[a]
      datos &= "|" & var.Prov_observaciones[a]
      tipos = "                 "
      datosproveedor &= Escribe.esquemaGenerico(esquema, datos, TIPOS) & "\r"

    End If

  Next

  TextAreaInforme.text &= datosproveedor & "\r\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'--------------------------------------------------Generacion Listado -----------------------------
'-----------------------------------------------------Salidas/Entradas Almacen---------------------
'--------------------------------------------------------------------------------------------------

Public Sub generaSalidas()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim esquema2 As String
  Dim datos As String
  Dim elementos As Integer 'contine el numero de elmentos a listar (albaranes, proveedores)
  Dim costeentrada As Float
  Dim costesalida As Float
  Dim anterior As String
  Dim sumaentrada As Float
  Dim sumasalida As Float
  Dim sumacosteentrada As Float
  Dim sumacostesalida As Float
  Dim validar As Boolean
  ' entradas de conceptos en albaran
  'PUBLIC entrada_numero AS Integer
  'PUBLIC entrada_id AS NEW String[] ''debe de ser el numero id de albaran (que da automaticamente el programa)
  'PUBLIC entrada_idconcepto AS NEW String[] 'le ponga la medida del concepto que tiene el albaran
  'PUBLIC entrada_medidaconcepto AS NEW FLOAT[]  'le ponga la medida del concepto que tiene el albaran
  'PUBLIC entrada_precio AS NEW FLOAT[] 'precio del concepto
  'PUBLIC entrada_tipoprecio AS NEW String[] ' contrado, estimacion, oferta
  'PUBLIC entrada_salida AS NEW float[] 'cantidad de salida

  Dim costetotalentrada As Float 'v 0.0.8
  Dim costetotalsalida As Float ' v 0.0.8
  Dim costatotalacopio As Float ' v 0.0.8

  'listar los concecptos con entradas / salidas

  'Message.Info("Se lista los Entradas/Salidas de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  elementos = var.entrada_numero

  lista.Resize(elementos)

  esquema = "Id:        Ud.  Nombre                    Cant.Entrada     Cant.Salida   Cant.Acopio     Precio    Tipo       Coste_Entrada Coste_Salida   Coste_Acopio"

  For a = 0 To elementos - 1
    lista[a] = buscar.buscaIdUd(var.entrada_idconcepto[a]) & buscar.buscaDenoConcepto(var.entrada_idconcepto[a])
  Next
  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Entrada/Salidas de la obra " & FMain.ComboBoxObras.text & " (MATERIALES)\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"
  anterior = ""

  For c = 0 To elementos - 1
    a = numeracion[c]
    'deben de ser conceptos:
    ' tipo materiales, la entrada no borrada, y  la obra la actual
    validar = var.entrada_idconcepto[a] <> "IdB" And buscar.buscaObra(var.entrada_idconcepto[a]) = FMain.ComboBoxObras.text And buscar.buscatipoconcepto(var.entrada_idconcepto[a]) = "materiales"

    If validar Then
      If anterior = "" Then
        datos = buscar.buscaIdUd(var.entrada_idconcepto[a])
        datos &= "|" & buscar.buscaUd(var.entrada_idconcepto[a])
        datos &= "|" & buscar.buscaDenoConcepto(var.entrada_idconcepto[a])
        datos &= "|" & var.entrada_medidaconcepto[a]
        datos &= "|" & var.entrada_salida[a]
        datos &= "|" & Str$(var.entrada_medidaconcepto[a] - var.entrada_salida[a]) 'acopio dif entre entradas-salidas
        datos &= "|" & var.entrada_precio[a]
        datos &= "|" & var.entrada_tipoprecio[a]
        costeentrada = var.entrada_medidaconcepto[a] * var.entrada_precio[a]
        datos &= "|" & Str$(Round(costeentrada, -2)) 'Coste_Entrada
        costesalida = var.entrada_salida[a] * var.entrada_precio[a]
        datos &= "|" & Str$(Round(costesalida, -2)) ' Coste_Salida
        datos &= "|" & Str$(costeentrada - costesalida) ' Coste_Acopio"
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "   #### ###  ") & "\r"

        anterior = buscar.buscaIdUd(var.entrada_idconcepto[a])
        sumaentrada += var.entrada_medidaconcepto[a]
        sumasalida += var.entrada_salida[a]
        sumacosteentrada += costeentrada
        sumacostesalida += costesalida
        Goto primeraEntrada
      Else
        'quiere decir que no es el primero que escribe
        If buscar.buscaIdUd(var.entrada_idconcepto[a]) = anterior Then
          'escribo igual que antes
          datos = buscar.buscaIdUd(var.entrada_idconcepto[a])
          datos &= "|" & buscar.buscaUd(var.entrada_idconcepto[a])

          datos &= "|" & buscar.buscaDenoConcepto(var.entrada_idconcepto[a])
          datos &= "|" & var.entrada_medidaconcepto[a]
          datos &= "|" & var.entrada_salida[a]
          datos &= "|" & Str$(var.entrada_medidaconcepto[a] - var.entrada_salida[a]) 'acopio dif entre entradas-salidas
          datos &= "|" & var.entrada_precio[a]
          datos &= "|" & var.entrada_tipoprecio[a]
          costeentrada = var.entrada_medidaconcepto[a] * var.entrada_precio[a]
          datos &= "|" & Str$(Round(costeentrada, -2)) 'Coste_Entrada
          costesalida = var.entrada_salida[a] * var.entrada_precio[a]
          datos &= "|" & Str$(Round(costesalida, -2)) ' Coste_Salida
          datos &= "|" & Str$(costeentrada - costesalida) ' Coste_Acopio"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "   #### ###  ") & "\r"

          anterior = buscar.buscaIdUd(var.entrada_idconcepto[a])
          sumaentrada += var.entrada_medidaconcepto[a]
          sumasalida += var.entrada_salida[a]
          sumacosteentrada += costeentrada
          sumacostesalida += costesalida

        Else

          'escribo tutales
          datos = Str$(sumaentrada)
          datos &= "|" & Str$(sumasalida)
          datos &= "|" & Str$(sumaentrada - sumasalida)
          datos &= "|" & Str$(sumacosteentrada)
          datos &= "|" & Str$(sumacostesalida)
          datos &= "|" & Str$(sumacosteentrada - sumacostesalida)
          esquema2 = "                                          ---------------- ------------- ----------------                     ------------- ------------   -------------"
          TextAreaInforme.text &= esquema2 & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "######  ") & "\r" & "\r"

          'empiezo otro concepto
          anterior = buscar.buscaIdUd(var.entrada_idconcepto[a])

          costetotalentrada += sumacosteentrada
          costetotalsalida += sumacostesalida
          costatotalacopio += sumacosteentrada - sumacostesalida

          sumaentrada = 0
          sumasalida = 0
          sumacosteentrada = 0
          sumacostesalida = 0

          'escribo concepto siguiente
          datos = buscar.buscaIdUd(var.entrada_idconcepto[a])
          datos &= "|" & buscar.buscaUd(var.entrada_idconcepto[a])
          datos &= "|" & buscar.buscaDenoConcepto(var.entrada_idconcepto[a])
          datos &= "|" & var.entrada_medidaconcepto[a]
          datos &= "|" & var.entrada_salida[a]
          datos &= "|" & Str$(var.entrada_medidaconcepto[a] - var.entrada_salida[a]) 'acopio dif entre entradas-salidas
          datos &= "|" & var.entrada_precio[a]
          datos &= "|" & var.entrada_tipoprecio[a]
          costeentrada = var.entrada_medidaconcepto[a] * var.entrada_precio[a]
          datos &= "|" & Str$(Round(costeentrada, -2)) 'Coste_Entrada
          costesalida = var.entrada_salida[a] * var.entrada_precio[a]
          datos &= "|" & Str$(Round(costesalida, -2)) ' Coste_Salida
          datos &= "|" & Str$(costeentrada - costesalida) ' Coste_Acopio"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "   #### ###  ") & "\r"

          anterior = buscar.buscaIdUd(var.entrada_idconcepto[a])
          sumaentrada += var.entrada_medidaconcepto[a]
          sumasalida += var.entrada_salida[a]
          sumacosteentrada += costeentrada
          sumacostesalida += costesalida
        Endif
      Endif
    End If

  primeraEntrada:
  Next

  If anterior <> "" Then
    'imprimo totales en el ultimo
    datos = Str$(sumaentrada)
    datos &= "|" & Str$(sumasalida)
    datos &= "|" & Str$(sumaentrada - sumasalida)
    datos &= "|" & Str$(sumacosteentrada)
    datos &= "|" & Str$(sumacostesalida)
    datos &= "|" & Str$(sumacosteentrada - sumacostesalida)
    esquema2 = "                                          ---------------- ------------- ----------------                     ------------- ------------   -------------"
    TextAreaInforme.text &= esquema2 & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "######  ") & "\r"

    costetotalentrada += sumacosteentrada
    costetotalsalida += sumacostesalida
    costatotalacopio += sumacosteentrada - sumacostesalida

  Endif

  ' debe de imprimir el total Coste Entrada, total Coste Salida, Total Coste En Acopio

  datos = Str$(costetotalentrada)
  datos &= "|" & Str$(costetotalsalida)
  datos &= "|" & Str$(costatotalacopio)
  esquema2 = "                                                                                                              ------------- ------------   -------------"
  TextAreaInforme.text &= esquema2 & "\r"
  TextAreaInforme.text &= "                                                                                                       TOTALES     ENTRADA     SALIDA          ACOPIO" & "\r"
  TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "###  ") & "\r"

  TextAreaInforme.text &= "\r\r" & "Entrada/Salidas de la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, " dddd yyyy/mm/dd hh: nn: ss ")

End

'--------------------------------------------------Generacion Listado -----------------------------
'-----------------------------------------------------Conceptos-----------------------------------
'--------------------------------------------------------------------------------------------------

Public Sub generaConceptos()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String

  'Message.Info("Se lista los conceptos de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  lista.Resize(var.concepto_numero)

  For a = 0 To var.concepto_numero - 1
    lista[a] = var.conceptotipo[a] & var.concepto_idudobra[a] & var.concepto_nombre[a]
  Next

  numeracion = OrdenacionLista.listaOrd(lista, var.concepto_numero)

  TextAreaInforme.text = "Conceptos de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Tipo             Id:        Ud.  Nombre                    Medicion       Precio      "

  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"
  For c = 0 To var.concepto_numero - 1
    a = numeracion[c]

    If var.concepto_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.concepto_Obra[a] Then
      datos = var.conceptotipo[a] 'texto
      datos &= "|" & var.concepto_idudobra[a] 'texto
      datos &= "|" & var.concepto_ud[a] 'texto
      datos &= "|" & var.concepto_nombre[a] 'texto
      datos &= "|" & var.concepto_med[a] 'numero
      datos &= "|" & var.concepto_precio[a] 'numero

      'tipo valido "   ##   "
      TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    ##   ") & "\r"

    End If

  Next
  TextAreaInforme.text &= "\r\r" & "Conceptos de la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'--------------------------------------------------Generacion Listado -----------------------------
'-----------------------------------------------------Albaranes------------------------------------
'--------------------------------------------------------------------------------------------------

Public Sub generaAlbaranes()
  'PUBLIC alb_id AS NEW String[]
  'PUBLIC alb_numeroprov AS NEW string[] 'numero del albaran dado por el proveedor
  'PUBLIC alb_prov AS NEW String[]
  'PUBLIC alb_fecha AS NEW date[] 'fecha del albaran
  'PUBLIC alb_idobra AS NEW String[]
  'PUBLIC alb_imp AS NEW String[]
  'PUBLIC alb_fechaEnt AS NEW date[] 'entrada en obra
  'PUBLIC alb_valor AS NEW float[]
  'PUBLIC albmemoria AS NEW Integer[]
  'PUBLIC alb_numero AS Integer '

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float

  'Message.Info("Se lista los albaranes de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  elementos = var.alb_numero
  lista.Resize(elementos)

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & var.alb_fecha[a] & var.alb_numeroprov[a] 'ordena primero por proveedor , fecha albaran y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Albaran de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Proveedor       Numero    Valor        Fecha       FechaEnt    Imp"
  esquema2 = "                           --------------"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.alb_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.alb_idobra[a]
    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.alb_prov[a] 'texto
        datos &= "|" & var.alb_numeroprov[a] 'texto
        datos &= "|" & var.alb_valor[a] 'numero
        datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.alb_imp[a] 'texto
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
        anterior = var.alb_prov[a]
        sumaalbaran += var.alb_valor[a]
        Goto primeraalbaran
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.alb_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          Goto primeraalbaran
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaalbaran

          linea = "             SUBTOTAL      --------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaalbaran
          'empiezo otro proveedor
          sumaalbaran = 0
          anterior = var.alb_valor[a]
          'escribo el siguiente proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]

        Endif
      Endif
    End If

  primeraalbaran:
  Next

  If anterior <> "" Then
    datos = sumaalbaran
    linea = "             SUBTOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaalbaran

    'e imprimo el total
    datos = SUBtotal

    linea = "                TOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"

  End If

  TextAreaInforme.text &= "\r\r" & "Albaran de la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'--------------------------------------------------------------------------------------
'------------------------------------- facturas ---------------------------------------
'--------------------------------------------------------------------------------------

Public Sub generaFacturas()
  ' fact_id AS NEW String[] 'id dado por el programa a cada factura introducida
  ' fact_prov AS NEW String[] 'nombre del proveedor de esta factura
  ' fact_nprov AS NEW String[] 'numero de factura que da n ºfacturadadaproveedor   (nº de factura que le da el proveedor)
  ' fact_idobra AS NEW String[] 'obra a la que pertenece la factura
  ' fact_fecha AS NEW Date[] 'fecha de la factura (la que tiene la factura)
  ' fact_fecha_imp AS NEW date[] 'fecha de imputacion factura
  ' fact_valor AS NEW float[] ' suma de los valores de los albaranes de la factura
  ' fact_numero AS Integer 'numero de facturas existentes

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim sumaproveedor As Float
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String

  'Message.Info("Se lista las facturas de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....

  elementos = var.fact_numero
  lista.Resize(elementos)

  'ordena los elementos
  For a = 0 To elementos - 1
    lista[a] = var.fact_prov[a] & var.fact_fecha[a] & var.fact_nprov[a] 'ordena primero por proveedor, fecha factura y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Facturas de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Proveedor       Numero    Fecha        Fecha_Imp       Importe            "

  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.fact_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.fact_idobra[a]

    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.fact_prov[a] 'texto
        datos &= "|" & var.fact_nprov[a] 'texto
        datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.fact_valor[a] 'valor
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
        sumaproveedor += var.fact_valor[a]
        anterior = var.fact_prov[a]
        Goto primeraFACTURA
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.fact_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.fact_prov[a] 'texto
          datos &= "|" & var.fact_nprov[a] 'texto
          datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.fact_valor[a] 'valor
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
          sumaproveedor += var.fact_valor[a]
          anterior = var.fact_prov[a]
          Goto primeraFACTURA
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaproveedor
          esquema2 = "                                                        ------------------"
          linea = "                                         SUBTOTAL       ------------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaproveedor
          'empiezo otro proveedor
          sumaproveedor = 0
          anterior = var.fact_prov[a]

          'escribo el siguiente proveedor con la 1º factura
          datos = var.fact_prov[a] 'texto
          datos &= "|" & var.fact_nprov[a] 'texto
          datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.fact_valor[a] 'valor
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
          sumaproveedor += var.fact_valor[a]
          anterior = var.fact_prov[a]
        Endif
      Endif
    Endif

  primeraFACTURA:
  Next

  If anterior <> "" Then
    'imprimo totales del ultimo proveedor
    datos = sumaproveedor
    esquema2 = "                                                        ------------------"
    LINEA = "                                            SUBTOTAL    ------------------"
    TextAreaInforme.text &= LINEA & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaproveedor
    'e imprimo el total de facturas
    datos = SUBtotal
    esquema2 = "                                                        ------------------"
    LINEA = "                                            TOTAL       ------------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"

  End If

  TextAreaInforme.text &= "\r\r" & "Facturas la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

Public Sub GridInforme_Click()

End

Public Sub Button1_Click()

  Me.CLOSE

End

'---------------------------------------------------------------
'botones del informe
'---------------------------------------------------------------

Public Sub ToolButton3_Click()

  Clipboard.Copy(TextAreaInforme.Text)

End

Public Sub ToolButton1_Click()
  'guardar en formato txt

  Dim destino As String
  Dim fecha As String

  Dialog.Title = "Escriba  un nombre de archivo para guardar el texto"
  Dialog.Filter = ["", ""]
  Dialog.Path = User.Name

  dialog.Filter = ["*.txt", "archivo de texto simple"]
  If Not Dialog.SaveFile() Then
    If Right$(Dialog.Path, Len(".txt")) <> ".txt" Then
      destino = Dialog.Path & ".txt"
    Else
      destino = Dialog.Path
    End If

    File.Save(destino, TextAreaInforme.text)
    Message.info("Salvado correctamente")
  End If

End

'--------------------------------------------------Generacion Listado -----------------------------
'------------------------------------------------Albaranes Descompuestos----------------------------
'--------------------------------------------------------------------------------------------------

Public Sub generaraAlbaranesDescompuesto()
  'PUBLIC alb_id AS NEW String[]
  'PUBLIC alb_numeroprov AS NEW string[] 'numero del albaran dado por el proveedor
  'PUBLIC alb_prov AS NEW String[]
  'PUBLIC alb_fecha AS NEW date[] 'fecha del albaran
  'PUBLIC alb_idobra AS NEW String[]
  'PUBLIC alb_imp AS NEW String[]
  'PUBLIC alb_fechaEnt AS NEW date[] 'entrada en obra
  'PUBLIC alb_valor AS NEW float[]
  'PUBLIC albmemoria AS NEW Integer[]
  'PUBLIC alb_numero AS Integer '

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float

  ' Message.Info("Se lista los albaranes de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  elementos = var.alb_numero
  lista.Resize(elementos)

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & var.alb_fecha[a] & var.alb_numeroprov[a] 'ordena primero por proveedor, fecha y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Albaran de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema2 = "                           --------------"
  esquema = "Proveedor       Numero    Valor        Fecha       FechaEnt    Imp"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.alb_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.alb_idobra[a]
    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.alb_prov[a] 'texto
        datos &= "|" & var.alb_numeroprov[a] 'texto
        datos &= "|" & var.alb_valor[a] 'numero
        datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.alb_imp[a] 'texto
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
        anterior = var.alb_prov[a]
        sumaalbaran += var.alb_valor[a]
        TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Goto primeraalbaran
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.alb_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
          Goto primeraalbaran
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaalbaran

          linea = "             SUBTOTAL      --------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaalbaran
          'empiezo otro proveedor
          sumaalbaran = 0
          anterior = var.alb_valor[a]
          'escribo el siguiente proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Endif
      Endif
    End If

  primeraalbaran:
  Next

  If anterior <> "" Then
    datos = sumaalbaran
    linea = "             SUBTOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaalbaran
    'e imprimo el total
    datos = SUBtotal

    linea = "                TOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
  End If
  TextAreaInforme.text &= "\r\r" & "Albaran de la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

Public Function DescompuestoAlbaran(idalbaran As String) As String

  Dim LINEa As String
  Dim ESQUEMA As String
  Dim A As Integer
  Dim DATOS As String
  '"idAlb" buscar.AlbaranSimple(GridViewAlbaran[GridViewalbaran.ROW, 2].TEXT)
  esquema = "                                                                     Ud  Concepto                                Medida      Precio      Total        TipoPrecio  TipoConcepto"

  LINEa = Escribe.subraya(esquema) & "\r"

  'LINEa = ESQUEMA & "\r"

  For a = 0 To var.entrada_numero - 1
    'PRINT var.Prov_id[a]; "IdB"; var.Prov_id[a] = "IdB"

    If var.entrada_idconcepto[a] <> "IdB" And idalbaran = var.entrada_id[a] Then

      datos = buscar.buscaUd(var.entrada_idconcepto[a])
      datos &= "|" & buscar.buscaDenoConcepto(var.entrada_idconcepto[a])
      datos &= "|" & var.entrada_medidaconcepto[a]
      datos &= "|" & var.entrada_precio[a]
      datos &= "|" & Str$(var.entrada_medidaconcepto[a] * var.entrada_precio[a])
      datos &= "|" & var.entrada_tipoprecio[a]
      datos &= "|" & buscar.buscatipoconcepto(var.entrada_idconcepto[a])
      LINEa &= Escribe.esquemaGenerico(esquema, datos, "  ###               ") & "\r"
    End If
  Next

  Return linea

End

'-------------------------------------------------------------------------------------------
' Resumen Prov. Alb. Fact y saldos de obra
'-------------------------------------------------------------------------------------------
Sub generaraResumenProvAlbFact()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String

  'para fecha
  Dim hastafecha As Date
  'for next
  Dim c1 As Integer
  Dim provedorC As String
  Dim sumafactura As Float
  Dim sumaalbaran As Float
  Dim SUBtotalalbaran As Float
  Dim SUBtotalfactura As Float

  'por cada proveedor de una determinada obra hay que:
  'una columna sumando los albaranes
  'otra columnas sumando las factura
  'imprimir un sumatorio parcial por cada proveedor y total por Obra
  'discrimirnar hasta una fecha (de entrada en obra) no la que venga en factura o albaran

  numeracion = OrdenacionLista.listaOrd(var.Prov_nombre, var.Prov_numero)

  hastafecha = Preguntarhastafecha()
  TextAreaInforme.text = "Informe de Proveedores / Albaranes / Facturas / Saldos hasta la fecha " & Str$(hastafecha) & "\r"
  TextAreaInforme.text &= "Listado generado el " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Nif:        Proveedor          Albaranes         Facturas          Saldos        "
  textareainforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To var.Prov_numero - 1
    a = numeracion[c]
    provedorC = var.Prov_id[a]

    If var.Prov_id[a] <> "IdB" Then
      'lee todos los albaranes,que no esten borrados
      ', los que sean del proveedor
      'y meno o igual de fecha'
      'los que sean de la obra
      ' le suma su valor
      sumaalbaran = 0
      For c1 = 0 To var.alb_numero - 1
        validar = var.alb_prov[c1] = var.Prov_nombre[a] And var.alb_fechaEnt[c1] <= hastafecha And var.alb_id[c1] <> "IdB" And FMain.LabelidObraInforme.text = var.alb_idobra[c1]
        If validar Then
          sumaalbaran += var.alb_valor[c1]
        End If
      Next

      ' lee todas las facturas, que no esten borrados, las que sean del proveedor y menor o igual de fecha, le suma su valor
      sumafactura = 0
      For c1 = 0 To var.fact_numero - 1
        validar = var.fact_prov[c1] = var.Prov_nombre[a] And var.fact_fecha_imp[c1] <= hastafecha And var.fact_id[c1] <> "IdB" And FMain.LabelidObraInforme.text = var.fact_idobra[c1]
        If validar Then
          sumafactura += var.fact_valor[c1]
        End If
      Next

      datos = var.Prov_Nif[a]
      datos &= "|" & var.Prov_nombre[a]
      datos &= "|" & Str$(sumaalbaran)
      datos &= "|" & Str$(sumafactura)
      datos &= "|" & Str$(sumaalbaran - sumafactura)
      SUBtotalalbaran += sumaalbaran ' no poner &= que no son cadenas de caracteres
      SUBtotalfactura += sumafactura ' no poner &= que no son cadenas de caracteres
      '  TextAreaInforme.text &= "          Subtotal             ------------------  ---------------  -----------     " & "\r"

      TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  ###  ") & "\r" '& "\r"

    Endif

  Next

  'imprimo totales
  datos = Str$(SUBtotalalbaran)
  datos &= "|" & Str$(SUBtotalfactura)
  datos &= "|" & Str$(SUBtotalalbaran - SUBtotalfactura)

  'hay que imprimir totales
  TextAreaInforme.text &= "             Totales          ------------------  ---------------  -----------     " & "\r"
  esquema2 = "                                ---------------  -------------    ------------     "
  TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "###  ") & "\r" & "\r"

  TextAreaInforme.text &= "\r\r" & "Informe de Proveedores / Albaranes / Facturas / Saldos hasta la fecha " & Str$(hastafecha) & "\r"
  TextAreaInforme.text &= "Listado generado el " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'funcion preguntar hasta que fecha
Public Function Preguntarhastafecha() As Date

  var.fechaincluida = Val(FMain.LabelFechaTrabajoInforme.text)

  Ffechadia.ShowModal

  Return var.fechaincluida

End

'-------------------------------------------------------------------------------------
'                              Descompuesto de Factura
'-------------------------------------------------------------------------------------

Sub generaraDescompuestoFactura()
  ' fact_id AS NEW String[] 'id dado por el programa a cada factura introducida
  ' fact_prov AS NEW String[] 'nombre del proveedor de esta factura
  ' fact_nprov AS NEW String[] 'numero de factura que da n ºfacturadadaproveedor   (nº de factura que le da el proveedor)
  ' fact_idobra AS NEW String[] 'obra a la que pertenece la factura
  ' fact_fecha AS NEW Date[] 'fecha de la factura (la que tiene la factura)
  ' fact_fecha_imp AS NEW date[] 'fecha de imputacion factura
  ' fact_valor AS NEW float[] ' suma de los valores de los albaranes de la factura
  ' fact_numero AS Integer 'numero de facturas existentes

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim sumaproveedor As Float
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim hastafecha As Date

  'Message.Info("Se lista las facturas de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  hastafecha = Preguntarhastafecha()

  'ordenar alfabeticamente.....
  elementos = var.fact_numero
  lista.Resize(elementos)

  'ordena los elementos
  For a = 0 To elementos - 1
    lista[a] = var.fact_prov[a] & var.fact_fecha[a] & var.fact_nprov[a] 'ordena primero por proveedor y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Facturas de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & ". Hasta la fecha " & Str$(hastafecha) & "\r\r"

  esquema = "Proveedor       Numero    Fecha        Fecha_Imp       Importe            "

  TextAreaInforme.text &= esquema & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.fact_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.fact_idobra[a] And var.fact_fecha_imp[a] <= hastafecha

    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.fact_prov[a] 'texto
        datos &= "|" & var.fact_nprov[a] 'texto
        datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.fact_valor[a] 'valor
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
        sumaproveedor += var.fact_valor[a]
        anterior = var.fact_prov[a]
        TextAreaInforme.text &= descompuestoFActura(var.fact_id[a], var.fact_prov[a], hastafecha, var.fact_idobra[a])
        Goto primeraFACTURA
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.fact_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.fact_prov[a] 'texto
          datos &= "|" & var.fact_nprov[a] 'texto
          datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.fact_valor[a] 'valor
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
          sumaproveedor += var.fact_valor[a]
          anterior = var.fact_prov[a]
          TextAreaInforme.text &= descompuestoFActura(var.fact_id[a], var.fact_prov[a], hastafecha, var.fact_idobra[a])
          Goto primeraFACTURA
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaproveedor
          esquema2 = "                                                        ------------------"
          linea = "                                         SUBTOTAL       ------------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaproveedor
          'empiezo otro proveedor
          sumaproveedor = 0
          anterior = var.fact_prov[a]

          'escribo el siguiente proveedor con la 1º factura
          datos = var.fact_prov[a] 'texto
          datos &= "|" & var.fact_nprov[a] 'texto
          datos &= "|" & Format$(var.fact_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.fact_fecha_imp[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.fact_valor[a] 'valor
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "    #  ") & "\r"
          sumaproveedor += var.fact_valor[a]
          anterior = var.fact_prov[a]
          TextAreaInforme.text &= descompuestoFActura(var.fact_id[a], var.fact_prov[a], hastafecha, var.fact_idobra[a])

        Endif
      Endif
    Endif

  primeraFACTURA:
  Next

  If anterior <> "" Then
    'imprimo totales del ultimo proveedor
    datos = sumaproveedor
    esquema2 = "                                                        ------------------"
    LINEA = "                                            SUBTOTAL    ------------------"
    TextAreaInforme.text &= LINEA & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaproveedor
    'e imprimo el total de facturas
    datos = SUBtotal
    esquema2 = "                                                        ------------------"
    LINEA = "                                            TOTAL       ------------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"

  End If

  TextAreaInforme.text &= "Facturas de la obra " & FMain.ComboBoxObras.text & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & ". Hasta la fecha " & Str$(hastafecha) & "\r\r"

End

'-----------------------------------------------------------------------------------------
'----------------------------------- alb aranes que contiene una factura -----------------
'-----------------------------------------------------------------------------------------

Sub descompuestoFActura(Idfactura As String, idproveedor As String, fechaincluida As Date, idobra As String) As String

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float
  Dim descompuestotexto As String
  Dim contador As Integer 'cuenta cuantos albaranes estan inclido en la factura

  elementos = var.alb_numero
  lista.Resize(elementos)

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & Str$(var.alb_fechaEnt[a]) & var.alb_numeroprov[a]   'ordena primero por proveedor y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  esquema2 = "                                                                   Albaran      Valor        Fecha       FechaEnt    Imp"
  descompuestotexto = esquema2 & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    ' Comprobar que: que no este borrado, que este imputado a la factura,
    ' que el proveedor coincida, y que la fecha de imputacion sea inferior o igual a la fechaincluida
    validar = var.alb_id[a] <> "IdB" And idproveedor = var.alb_prov[a] And Mid$(var.alb_imp[a], 4, Len(var.alb_imp[a])) = idfactura And fechaincluida >= var.alb_fechaEnt[a] And idobra = var.alb_idobra[a]

    If validar Then
      datos = var.alb_numeroprov[a] 'texto
      datos &= "|" & var.alb_valor[a] 'numero
      datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
      datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
      datos &= "|" & var.alb_imp[a] 'texto
      descompuestotexto &= Escribe.esquemaGenerico(esquema2, datos, " #        ") & "\r"
      contador += 1
    End If

  Next

  If contador > 0 Then
    Return descompuestotexto
  Else
    Return ""
  Endif

End

Public Sub ToolButtonHtml_Click()
  'EMPEZAMOS..... utilizamos caracteres internacionalizacion UTF-8

  Dim destino As String
  Dim a As Integer

  convertirHTML.textohtml = "<?xml version=" & Chr$(34) & "1.0" & Chr$(34) & " encoding=" & Chr$(34) & "UTF-8" & Chr$(34) & "?>" & Chr$(13)
  convertirHTML.textohtml = convertirHTML.textohtml & "<!DOCTYPE html PUBLIC " & Chr$(34) & "-//W3C//DTD XHTML 1.1//EN" & Chr$(34) & Chr$(13)
  convertirHTML.textohtml = convertirHTML.textohtml & " " & Chr$(34) & "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd" & Chr$(34) & ">" & Chr$(13)

  convertirHTML.textohtml = convertirHTML.textohtml & "<HTML xmlns=" & Chr$(34) & "http://www.w3.org/1999/xhtml" & Chr$(34) & " xml:lang =" & Chr$(34) & "es" & Chr$(34) & ">" & Chr$(13)

  convertirHTML.textohtml = convertirHTML.textohtml & "</HEAD>" & Chr$(13)

  convertirHTML.textohtml = convertirHTML.caracteresUTF8_2()

  convertirHTML.textohtml = convertirHTML.textohtml & "</HEAD>" & Chr$(13)

  convertirHTML.textohtml = convertirHTML.textohtml & "<BODY>"
  convertirHTML.textohtml = convertirHTML.textohtml & "<font size=" & Chr$(34) & "1" & Chr$(34) & ">"

  convertirHTML.textohtml = convertirHTML.textohtml & "<font face=" & Chr$(34) & "Courier New" & Chr$(34) & ">"

  convertirHTML.textohtml = convertirHTML.Parrafo(TextAreaInforme.text)

  convertirHTML.textohtml = convertirHTML.textohtml & "</font></font>"
  convertirHTML.textohtml = convertirHTML.textohtml & "</BODY>"

  convertirHTML.textohtml = convertirHTML.textohtml & " </HTML>"

inicio:

  destino = "/home/" & User.name & "/listado.html"

  File.Save(destino, convertirHTML.textohtml)

  Exec ["firefox", destino]

fins:

End
'--------------------------------------------------------------------------------
'----- DATOS DEL MES ---------------------------------
'--------------------------------------------------------------------------------

Public Sub generaMesResumenAlbaranes_Facturas()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String

  'para fecha
  Dim hastafecha As Date
  'for next
  Dim c1 As Integer
  Dim provedorC As String
  Dim sumafactura As Float
  Dim sumaalbaran As Float
  Dim SUBtotalalbaran As Float
  Dim SUBtotalfactura As Float
  Dim mes As String

  'por cada proveedor de una determinada obra hay que:
  'una columna sumando los albaranes
  'otra columnas sumando las factura
  'imprimir un sumatorio parcial por cada proveedor y total por Obra
  'discrimirnar hasta una fecha (de entrada en obra) no la que venga en factura o albaran

  numeracion = OrdenacionLista.listaOrd(var.Prov_nombre, var.Prov_numero)

  mes = Preguntarhastafecha()
  TextAreaInforme.text = "Informe de Proveedores / Albaranes / Facturas / Saldos del Mes: " & Upper$(Format$(var.fechaincluida, "mmmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado el " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema = "Nif:        Proveedor          Albaranes         Facturas          Saldos        "
  textareainforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To var.Prov_numero - 1
    a = numeracion[c]
    provedorC = var.Prov_id[a]

    If var.Prov_id[a] <> "IdB" Then
      'lee todos los albaranes,que no esten borrados
      ', los que sean del proveedor
      'y meno o igual de fecha'
      'los que sean de la obra
      ' le suma su valor
      sumaalbaran = 0
      For c1 = 0 To var.alb_numero - 1

        validar = var.alb_prov[c1] = var.Prov_nombre[a] And Format$(var.alb_fechaEnt[c1], "yyyy/mm") = Format$(var.fechaincluida, "yyyy/mm") And var.alb_id[c1] <> "IdB" And FMain.LabelidObraInforme.text = var.alb_idobra[c1]
        If validar Then
          sumaalbaran += var.alb_valor[c1]
        End If
      Next

      ' lee todas las facturas, que no esten borrados, las que sean del proveedor y menor o igual de fecha, le suma su valor
      sumafactura = 0
      For c1 = 0 To var.fact_numero - 1
        validar = var.fact_prov[c1] = var.Prov_nombre[a] And Format$(var.fact_fecha_imp[c1], "yyyy/mm") = Format$(var.fechaincluida, "yyyy/mm") And var.fact_id[c1] <> "IdB" And FMain.LabelidObraInforme.text = var.fact_idobra[c1]
        If validar Then
          sumafactura += var.fact_valor[c1]
        End If
      Next

      datos = var.Prov_Nif[a]
      datos &= "|" & var.Prov_nombre[a]
      datos &= "|" & Str$(sumaalbaran)
      datos &= "|" & Str$(sumafactura)
      datos &= "|" & Str$(sumaalbaran - sumafactura)
      SUBtotalalbaran += sumaalbaran ' no poner &= que no son cadenas de caracteres
      SUBtotalfactura += sumafactura ' no poner &= que no son cadenas de caracteres
      '  TextAreaInforme.text &= "          Subtotal             ------------------  ---------------  -----------     " & "\r"

      TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  ###  ") & "\r" '& "\r"

    Endif
  Next

  'imprimo totales
  datos = Str$(SUBtotalalbaran)
  datos &= "|" & Str$(SUBtotalfactura)
  datos &= "|" & Str$(SUBtotalalbaran - SUBtotalfactura)

  'hay que imprimir totales
  TextAreaInforme.text &= "             Totales          ------------------  ---------------  -----------     " & "\r"
  esquema2 = "                                ---------------  -------------    ------------     "
  TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "###  ") & "\r" & "\r"

  TextAreaInforme.text &= "\r\r" & "Informe de Proveedores / Albaranes / Facturas / Saldos del Mes: " & Upper$(Format$(var.fechaincluida, "mmmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado el " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

Public Sub generaMesAlbaranes_Facturas()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float
  Dim mes As String

  ' Message.Info("Se lista los albaranes de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  elementos = var.alb_numero
  lista.Resize(elementos)
  mes = Preguntarhastafecha()

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & var.alb_fecha[a] & var.alb_numeroprov[a] 'ordena primero por proveedor y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Albaranes de la obra " & FMain.ComboBoxObras.text & " Mes: " & Upper$(Format$(var.fechaincluida, "mmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema2 = "                           --------------"
  esquema = "Proveedor       Numero    Valor        Fecha       FechaEnt    Imp"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.alb_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.alb_idobra[a] And Format$(var.fechaincluida, "mmmm/yyyy") = Format$(var.alb_fechaEnt[a], "mmmm/yyyy")

    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.alb_prov[a] 'texto
        datos &= "|" & var.alb_numeroprov[a] 'texto
        datos &= "|" & var.alb_valor[a] 'numero
        datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.alb_imp[a] 'texto
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
        anterior = var.alb_prov[a]
        sumaalbaran += var.alb_valor[a]
        TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Goto primeraalbaran
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.alb_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
          Goto primeraalbaran
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaalbaran

          linea = "             SUBTOTAL      --------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaalbaran
          'empiezo otro proveedor
          sumaalbaran = 0
          anterior = var.alb_valor[a]
          'escribo el siguiente proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Endif
      Endif
    End If

  primeraalbaran:
  Next

  If anterior <> "" Then
    datos = sumaalbaran
    linea = "             SUBTOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaalbaran
    'e imprimo el total
    datos = SUBtotal

    linea = "                TOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
  End If

  TextAreaInforme.text &= "Albaranes de la obra " & FMain.ComboBoxObras.text & " Mes: " & Upper$(Format$(var.fechaincluida, "mmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'------------------------------------------------------------------------------------------------------------------------------------------------
' informe de alquileres por mes
'----------------------------------------------------------------------------------------
Public Sub generaMesalquileres()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float
  Dim mes As String

  ' Message.Info("Se lista los albaranes de la obra actual ( " & FMain.ComboBoxObras.text & " )")
  'ordenar alfabeticamente.....
  elementos = var.alb_numero
  lista.Resize(elementos)
  mes = Preguntarhastafecha()

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & var.alb_numeroprov[a] 'ordena primero por proveedor y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Albaranes de la obra " & FMain.ComboBoxObras.text & " Mes: " & Upper$(Format$(var.fechaincluida, "mmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema2 = "                           --------------"
  esquema = "Proveedor       Numero    Valor        Fecha       FechaEnt    Imp"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.alb_id[a] <> "IdB" And Fmain.ComboBoxObras.text = var.alb_idobra[a] And Format$(var.fechaincluida, "mmmm/yyyy") = Format$(var.alb_fechaEnt[a], "mmmm/yyyy") And DescompuestoAlbaranAlquileres(var.alb_id[a]) = "maq.med.aux"

    Print DescompuestoAlbaranAlquileres(var.alb_id[a])
    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.alb_prov[a] 'texto
        datos &= "|" & var.alb_numeroprov[a] 'texto
        datos &= "|" & var.alb_valor[a] 'numero
        datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.alb_imp[a] 'texto

        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
        anterior = var.alb_prov[a]
        sumaalbaran += var.alb_valor[a]
        TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Goto primeraalbaran
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.alb_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
          Goto primeraalbaran
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaalbaran

          linea = "             SUBTOTAL      --------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaalbaran
          'empiezo otro proveedor
          sumaalbaran = 0
          anterior = var.alb_valor[a]
          'escribo el siguiente proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Endif
      Endif
    End If

  primeraalbaran:
  Next

  If anterior <> "" Then
    datos = sumaalbaran
    linea = "             SUBTOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaalbaran
    'e imprimo el total
    datos = SUBtotal

    linea = "                TOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
  End If

  TextAreaInforme.text &= "Albaranes de la obra " & FMain.ComboBoxObras.text & " Mes: " & Upper$(Format$(var.fechaincluida, "mmmm/yyyy")) & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End

'comprobar que el descompuesto del albaran contiene materiales alquilados
Function DescompuestoAlbaranAlquileres(idalbaran As String) As String

  Dim A As Integer

  For a = 0 To var.entrada_numero - 1
    If var.entrada_idconcepto[a] <> "IdB" And idalbaran = var.entrada_id[a] And buscar.buscatipoconcepto(var.entrada_idconcepto[a]) = "maq.med.aux" Then
      Return "maq.med.aux"

    End If
  Next

  Return "no"

End

'-----------------------------------------------------------------------------------------------------------------------
'listado de albaranes por dia....
'----------------------------------------------------------------------------------------

Public Sub generaDescompuestosAlbDia()

  Dim a As Integer
  Dim b As Integer
  Dim fila As Integer
  Dim numeracion As New Integer[]
  Dim c As Integer
  Dim lista As New String[]
  Dim esquema As String
  Dim datos As String
  Dim elementos As Integer
  'para subtotales
  Dim esquema2 As String
  Dim validar As Boolean
  Dim anterior As String
  Dim SUBtotal As Float
  Dim linea As String
  Dim sumaalbaran As Float

  Dim fecha_dia As String

  elementos = var.alb_numero
  lista.Resize(elementos)

  fecha_dia = Preguntarhastafecha()

  For a = 0 To elementos - 1
    lista[a] = var.alb_prov[a] & var.alb_fecha[a] & var.alb_numeroprov[a] 'ordena primero por proveedor, fecha y luego por numero de proveedor
  Next

  numeracion = OrdenacionLista.listaOrd(lista, elementos)

  TextAreaInforme.text = "Albaran de la obra " & FMain.ComboBoxObras.text & ". Albaranes de fecha: " & fecha_dia & "\r"
  TextAreaInforme.text &= "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss") & "\r\r"

  esquema2 = "                           --------------"
  esquema = "Proveedor       Numero    Valor        Fecha       FechaEnt    Imp"
  TextAreaInforme.text &= Escribe.subraya(esquema) & "\r"

  For c = 0 To elementos - 1
    a = numeracion[c]
    validar = var.alb_id[a] <> "IdB" And FMain.ComboBoxObras.text = var.alb_idobra[a] And fecha_dia = var.alb_fecha[a]

    'PRINT fecha_dia, var.alb_fecha[a]

    If validar Then
      'imprimir un sumatorio por cada proveedor:
      If anterior = "" Then
        datos = var.alb_prov[a] 'texto
        datos &= "|" & var.alb_numeroprov[a] 'texto
        datos &= "|" & var.alb_valor[a] 'numero
        datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
        datos &= "|" & var.alb_imp[a] 'texto
        TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
        anterior = var.alb_prov[a]
        sumaalbaran += var.alb_valor[a]
        TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Goto primeraalbaran
      Else
        'quiere decir que no es el primera factura que imprime
        If anterior = var.alb_prov[a] Then
          'estamos en el mismo proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
          Goto primeraalbaran
        Else
          'hemos cambiado de proveedor
          ' tenemos que incluir el total de proveedor antes de pasar al nuevo, el subtotal
          datos = sumaalbaran

          linea = "             SUBTOTAL      --------------"
          TextAreaInforme.text &= linea & "\r"
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
          SUBtotal += sumaalbaran
          'empiezo otro proveedor
          sumaalbaran = 0
          anterior = var.alb_valor[a]
          'escribo el siguiente proveedor
          datos = var.alb_prov[a] 'texto
          datos &= "|" & var.alb_numeroprov[a] 'texto
          datos &= "|" & var.alb_valor[a] 'numero
          datos &= "|" & Format$(var.alb_fecha[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & Format$(var.alb_fechaEnt[a], "dd/mm/yy") 'texto (fecha en texto)
          datos &= "|" & var.alb_imp[a] 'texto
          TextAreaInforme.text &= Escribe.esquemaGenerico(esquema, datos, "  #        ") & "\r"
          anterior = var.alb_prov[a]
          sumaalbaran += var.alb_valor[a]
          TextAreaInforme.text &= DescompuestoAlbaran(var.alb_id[a])
        Endif
      Endif
    End If

  primeraalbaran:
  Next

  If anterior <> "" Then
    datos = sumaalbaran
    linea = "             SUBTOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
    SUBtotal += sumaalbaran
    'e imprimo el total
    datos = SUBtotal

    linea = "                TOTAL      --------------"
    TextAreaInforme.text &= linea & "\r"
    TextAreaInforme.text &= Escribe.esquemaGenerico(esquema2, datos, "#  ") & "\r" & "\r"
  End If
  TextAreaInforme.text &= "\r\r" & "Albaran de la obra " & FMain.ComboBoxObras.text & "\r" & "Listado generado en fecha: " & Format$(Now, "dddd yyyy/mm/dd hh:nn:ss")

End
